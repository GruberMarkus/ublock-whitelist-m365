name: Update M365 uBlock List

on:
  schedule:
    - cron: '0 */5 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-list:
    runs-on: ubuntu-slim
    steps:
      - name: Install uuidgen tool
        run: |
          sudo apt-get update
          sudo apt-get install -y uuid-runtime
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get M365 Endpoints and create uBlock list
        run: |
          GUID=$(uuidgen)
          echo "Generated GUID: $GUID"
          
          # 1. Get all available instances from the version endpoint
          INSTANCES=$(curl -s "https://endpoints.office.com/version?clientrequestid=$GUID" | jq -r '.[].instance' | sort -u)
          
          # 2. Initialize the uBlock filter list with metadata
          {
            echo "! Title: Microsoft 365 URL Whitelist (All Instances)"
            echo "! Version: $(date +%Y%m%d%H%M)"
            echo "! Filter list description: This filter list contains URLs for all M365 instances (Worldwide, China, USGov, etc.)"
            echo "! Expires: 24 hours"
            echo "! URL: https://raw.githubusercontent.com/${{ github.repository }}/main/ublock-whitelist-m365.txt"
            echo "! Homepage: https://github.com/${{ github.repository }}"
            echo "! Source: https://endpoints.office.com/version"
            echo "! Last Updated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            echo ""
          } > ublock-whitelist-m365.txt
          
          # 3. Loop through each instance and collect URLs
          TEMP_URLS=$(mktemp)
          for instance in $INSTANCES; do
            echo "Fetching endpoints for instance: $instance"
            # We use the instance name in the URL (e.g., .../endpoints/USGovGCCHigh)
            curl -s "https://endpoints.office.com/endpoints/$instance?clientrequestid=$GUID" | \
            jq -r '.[] | .urls? | .[]?' >> "$TEMP_URLS"
          done

          # 4. Deduplicate, format, and append to the final file
          cat "$TEMP_URLS" | sort -u | jq -Rr '"@@||" + . + "^"' >> ublock-whitelist-m365.txt

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ublock-whitelist-m365.txt
          git commit -m "chore: Update M365 uBlock list (All Instances)" || echo "No changes to commit."
          git push
